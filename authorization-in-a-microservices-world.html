<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.3">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Alexander&#39;s Blog Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Alexander&#39;s Blog Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-162440229-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Authorization in a microservices world | Alexander&#x27;s Blog</title><meta data-react-helmet="true" property="og:title" content="Authorization in a microservices world | Alexander&#x27;s Blog"><meta data-react-helmet="true" name="description" content="Authorization? How hard can it be? I am pretty sure that others have already solved it. We are not the first ones doing microservices. It should be easy to integrate what&#x27;s already out there."><meta data-react-helmet="true" property="og:description" content="Authorization? How hard can it be? I am pretty sure that others have already solved it. We are not the first ones doing microservices. It should be easy to integrate what&#x27;s already out there."><meta data-react-helmet="true" property="og:url" content="https://www.alexanderlolis.com/authorization-in-a-microservices-world"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://www.alexanderlolis.com/authorization-in-a-microservices-world"><link data-react-helmet="true" rel="alternate" href="https://www.alexanderlolis.com/authorization-in-a-microservices-world" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://www.alexanderlolis.com/authorization-in-a-microservices-world" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.8d78dd7f.css">
<link rel="preload" href="/assets/js/runtime~main.21506163.js" as="script">
<link rel="preload" href="/assets/js/main.6357892d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Alexander&#x27;s Blog Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.png" alt="Alexander&#x27;s Blog Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Alexander&#x27;s Blog</b></a><a class="navbar__item navbar__link" href="/about">About</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/alolis" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://www.linkedin.com/in/alexander-lolis-59aa2ab9" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/alexanderlolis" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Alexander&#x27;s Blog Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.png" alt="Alexander&#x27;s Blog Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Alexander&#x27;s Blog</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/about">About</a></li><li class="menu__list-item"><a href="https://github.com/alolis" target="_blank" rel="noopener noreferrer" class="menu__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="menu__list-item"><a href="https://www.linkedin.com/in/alexander-lolis-59aa2ab9" target="_blank" rel="noopener noreferrer" class="menu__link"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="menu__list-item"><a href="https://twitter.com/alexanderlolis" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">All Posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/authorization-in-a-microservices-world">Authorization in a microservices world</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/my-2021-reads">My 2021 reads</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/welcome-2022">Welcome 2022!</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/node-js-fork-is-slow-deal-with-it">Node.js fork is slow; Deal with it</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/riding-the-bull">Riding the bull; the npm package, that is</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/how-to-pass-the-first-round-of-my-interviews">How to pass the first round of my interviews</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/happy-2021">Happy 2021!</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/my-2020-reads">My 2020 reads</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/javascript-objects-cachification">JavaScript Objects Cachification</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/how-to-tag-data-in-redis">How to tag data in Redis</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/fight-or-flight-breathe-instead">Fight or flight? Breathe instead</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/remote-work-tips">Remote work tips - How NOT to snap</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/covid-19">COVID-19</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="blogPostTitle_GeHD">Authorization in a microservices world</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2022-03-20T00:00:00.000Z">March 20, 2022</time> Â· 26 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/alolis" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/82233?v=4" alt="Alexander Lolis"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/alolis" target="_blank" rel="noopener noreferrer">Alexander Lolis</a></div><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><blockquote><p>Authorization? How hard can it be? I am pretty sure that others have already solved it. We are not the first ones doing microservices. It should be easy to integrate what&#x27;s already out there. </p><p>- Everybody when they started designing their microservices, before they cried</p></blockquote><p><strong>Fine-grained authorization in microservices is hard.</strong> Definitely not impossible, but hard. You would expect that a more standardized, all-around, full-proof solution is out there, but I am afraid there isn&#x27;t. It&#x27;s a complex matter and depending on what you are building, implementation varies.</p><p>You will probably start with a boolean <code>admin</code> flag in your <code>User</code> model and then you will replace it with a <code>role</code> field, as we all did. However, as things progress and the business model becomes more and more complex, so do the solutions that we need to implement in order to deal with that complexity.</p><p>But how do you actually go <strong>from a simple flag</strong> to <strong>Role Based Access Control (RBAC)</strong> and then to <strong>Attribute Based Access Control (ABAC)</strong>, especially in a microservices environment? In the following post I hope to help you get there.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="the-monolith"></a>The monolith<a class="hash-link" href="#the-monolith" title="Direct link to heading">#</a></h2><p>The first time I had to deal with a more complex authorization system was in a <strong>monolithic CMS application</strong> written in <code>PHP 5.x</code>, on top of <strong>Zend Framework</strong> (now known as Laminas Project), with a <strong>MySQL</strong> backend, a billion years ago. The app was following the hot and trendy <strong>Model-View-Controller (MVC)</strong> pattern and the requirement in the specific project was, except hierarchical role-based access control (H-RBAC), to have more fine-grained permissions as well as to be able to answer two specific questions: </p><ol><li><strong>Can the user do X on a Y resource if their role allows it or if the resource is owned by them?</strong></li><li><strong>Can the user A, with role X, access the data of user B, that has the same or a higher level role?</strong></li></ol><p>(For the sake of simplicity and because it does not really offer any extra value, I will skip the implementation details of question 2 and I will just use question 1 for my example below).</p><p>After thinking about the situation, and the fact that we had a VERY specific problem to solve, that I KNEW it wouldn&#x27;t change in the future, and ALL the data models were associated with a single user, this is what a very simplified version looked like (forgive my PHP, it&#x27;s a bit rusty):</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">controllers/items_controller.php</div><div class="codeBlockContent_hGly php"><pre tabindex="0" class="prism-code language-php codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">class ItemsController extends Zend_Controller_Action {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...omitted code</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public function listAction() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    $page = $this-&gt;_getParam(&#x27;page&#x27;, 1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    $orderBy = $this-&gt;_getParam(&#x27;order_by&#x27;, &#x27;created_at&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    $order = $this-&gt;_getParam(&#x27;order&#x27;, &#x27;desc&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    $filters = array(&#x27;drafts&#x27; =&gt; false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    $user = Session::getUser();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ($user-&gt;isAuthorized(&#x27;can_list_drafts&#x27;, &#x27;items&#x27;)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      $filters[&#x27;drafts&#x27;] = $this-&gt;_getParam(&#x27;drafts&#x27;, false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    $result = ItemModel::find($filters, $page, $orderBy, $order);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return $result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public function destroyAction() </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    $itemId = $this-&gt;_request-&gt;getParam(&#x27;itemId&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    $item = ItemModel::findById($itemId);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!$item) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      throw new ItemNotFoundException();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    $user = Session::getUser();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!$user-&gt;hasRoleOrSelfPermissionOn(&#x27;can_delete_items&#x27;, &#x27;can_delete_own_items&#x27;, &#x27;items&#x27;, $item)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      throw new AuthorizationException();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    $result = $item-&gt;destroy();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return $result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ... rest of code</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">models/user.php</div><div class="codeBlockContent_hGly php"><pre tabindex="0" class="prism-code language-php codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">class User {    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...omitted code</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public isAuthorized($permission, $resource) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // The ACL singleton class is a wrapper around Zend ACL which is a module that provides you</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // with hierarchical, role based, access control lists which you can query and check</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // if a role has the requested permission on a resource.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ACL::getInstance()-&gt;isAuthorized($this-&gt;role, $permission, $resource)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return true;      </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public hasRoleOrSelfPermissionOn($rolePermission, $selfRolePermission, $resource, $model)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ($this-&gt;isAuthorized($rolePermission, $resource) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    elseif ($model.userId == $this.id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if ($this-&gt;isAuthorized($selfRolePermission, $resource))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...rest of code</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>A few things are going on above:</p><ol><li><strong>The decision point and enforcement of authorization is happening in the controller, getting mixed with application code that does not care about all these things</strong>, plus, it makes it harder to test. We do not want that. We want our controllers to be lean (in terms of responsibilities) and just return appropriate responses which are related to what was requested in the first place. </li><li>In <code>listAction</code> we need to check individual filters in order to decide if the user is authorized to use them or not. If multiple filters exist that need to be checked, the controller will become too messy, too fast.</li><li>The application data that the authorization requires (in this case <code>$item</code>) are locally available and easily loaded with our <code>ItemModel</code> class. As you will understand later, loading necessary application data is the biggest pain point.</li><li>The <code>User</code> class is suddenly coupled with authorization. It shouldn&#x27;t. It should only care about the user entity itself, like the class name implies.</li><li><code>hasRoleOrSelfPermissionOn</code> makes the assumption that all models have a <code>userId</code> field which means that we should know beforehand that this will be true (forever) or else the function will not work as expected. </li></ol><p><strong>The authorization code is tedious, poluting the controllers, and error prone</strong>. However, we were also lucky because this was the ugliest it could get (based on project requirements) and therefore it was acceptable (or at least we persuaded ourselves that it was), instead of pushing to a more complex solution. If, for example, there was the requirement of checking multiple model attributes (or attributes from different models), depending on the controller action, then <code>hasRoleOrSelfPermissionOn</code> wouldn&#x27;t be able to cover everything and the controllers would immediately become much messier. It did serve us well back then but I no longer like it because avoiding tangling code at some point became a priority.</p><p><strong>What I am describing above is not inherent to monoliths.</strong> The same implementation could have been done in a microservice (and I have seen it in multiple occasions, with everything done in the controllers) if the application data that the authorization mechanism required, lived under the same roof. But more on that later.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="so-what-could-we-have-done-to-improve-the-above-situation"></a>So, what could we have done to improve the above situation?<a class="hash-link" href="#so-what-could-we-have-done-to-improve-the-above-situation" title="Direct link to heading">#</a></h4><p>Push the authorization code higher up in the stack. That would mean that you could push it to somewhere like a <code>middleware</code>, as most web frameworks call it, which is basically code that is executed before your controllers. And this, is where the fun begins and a whole new set of implementation problems rises!</p><p>But before we dive into that, we need to think about our authorization flow in a more abstract level.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="authorization-flow-overview"></a>Authorization flow overview<a class="hash-link" href="#authorization-flow-overview" title="Direct link to heading">#</a></h2><p>So, what would this authorization mechanism look like in order to not force a single architecture but be more flexible instead?? The following diagram will give you an idea:</p><div style="text-align:center"><p><img alt="Authorization Overview" src="/assets/images/authorization_architecture_overview-a7f2e4f08870034de08c831e81aae323.jpg"></p></div><p><strong>The flow goes like this:</strong></p><ol><li>User requests to view record A.</li><li>The requested is intercepted by the <strong>Policy Enforcement Point (PEP)</strong>. This is usually a <strong>middleware</strong>, or generally speaking, a layer in your stack, as high as possible, in order for the request to stop right there in case it&#x27;s not authorized, instead of allowing it to travel deeper in the system.</li><li><strong>PEP</strong> makes a request to the <strong>Policy Decision Point (PDP)</strong> in order to figure out whether or not the request is authorized to move forward. PDP will probably be a library that keeps track of roles, permissions and resources and expose an interface in order to query it and get a boolean answer whether or not someone can do something on a resource.</li><li><strong>PDP</strong> <em>might</em> need extra information in order to decide if the request should be allowed or denied so it needs to ask the <strong>Policy Information Point (PIP)</strong> for that extra information. That extra information can be retrieved from a database, from a flat file, from an external service or from any other source you need. PIP could be just another library which PDP can use internally if it needs to.</li><li><strong>PIP</strong> loads the extra information and returns it to the PDP.</li><li><strong>PDP</strong>, in combination with the extra information it got from PIP, evaluates the defined policy (which can be stored anywhere you like, e.g. database or flat file), and decides whether or not the request has access to the underlying resource based on what the policy says. </li><li>The answer <strong>is returned to PEP</strong>, which either allows or denies the request to move forward.</li></ol><p>On the diagram above there is another piece, <strong>the Policy Administration Point (PAP)</strong>. This is basically an optional interface that helps you manage the policies. It can be anything, a web interface, a command line tool, a desktop GUI or you can just skip it entirely if you do not want to provide it and do everything manually instead.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="architectures"></a>Architectures<a class="hash-link" href="#architectures" title="Direct link to heading">#</a></h2><p>Now that we have defined our authorization flow, let&#x27;s go through a few real world architectures together. All the following architectures include a diagram and within this diagram I make clear what plays which role based on what I showed you earlier.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="with-an-authorization-service"></a>With an authorization service<a class="hash-link" href="#with-an-authorization-service" title="Direct link to heading">#</a></h3><p>So, you are there thinking, I am doing microservices, right? So the logical thing to do is to implement an <strong>authorization service</strong> and everybody would be able to use that and keep your precious service boundaries, right? <strong>WRONG</strong>. Your hell, has just begun!</p><div style="text-align:center"><p><img alt="Overview" src="/assets/images/authorization_architecture_authorization_service-131cac666b0b1feac9d7f636e04929bf.jpg"></p></div><p><strong>How will PIP fetch the application data that PDP needs?</strong></p><ol><li><strong>Direct DB reads:</strong> I am pretty sure someone will suggest this, and then will say, <em>&quot;I know we shouldn&#x27;t be doing this in microservices but let&#x27;s just make this exception&quot;</em>, but that&#x27;s how all big problems are created. With a small exception here, with another one there, and then things start to blow up, or even worst, become unmaintenable. Direct DB reads, outside the domain of each service, is a bad idea and it will be obvious to you why on the first schema change. Please don&#x27;t be lazy and just say no to this.</li><li><strong>Attach all the extra data to the authorization service call:.</strong> By doing this you will probably increase the network traffic and you might cause a bottleneck on the service if every request has a lot of data attached. However, these - manageable - disadvantages are not even my main concern with this approach. My main concern is the fact that the caller now needs to know the authorization logic that will be used internally by the authorization service in order to send the appropriate data. This will probably lead to callers sending more data than they should, or not removing data from the call whenever a policy changes, &quot;just to be sure&quot;, and as a result the code maintenance will become harder. Even in a perfect world, were the data are ALWAYS exactly what is needed, the extra work of choosing the data is a burden that the caller should not have.</li><li><strong>Keep a copy of the data the authorization service needs:</strong> This basically means syncing the data from all the other services, to the authorization service database, with a generic model that will be able to fit (in terms of a schema) everything. I can tell you right now that, this is difficult to achieve, especially if the syncing is experiencing network delays and/or conflicts. There are others who are doing this (check <a href="https://research.google/pubs/pub48190/" target="_blank" rel="noopener noreferrer">Google Zanzibar</a>), but for most mortal companies I think dealing with the complexities of syncing on your first implementation, is an overkill. Besides, even Zanzibar is not a silver bullet and it&#x27;s higly opinionated with its models, so you might need to build extra parts that communicate with it in order to achieve what you want. </li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="with-an-authorization-service-and-a-data-service"></a>With an authorization service and a data service<a class="hash-link" href="#with-an-authorization-service-and-a-data-service" title="Direct link to heading">#</a></h3><div style="text-align:center"><p><img alt="Overview" src="/assets/images/authorization_architecture_authorization_and_data_service-69c2c84ecf53d7527e708c695c554f55.jpg"></p></div><p>This is probably the most complex architecture but it definitely clears things up a bit. If the data state and the mutations are all handled by the same layer (a data service), and all other services use that layer, it&#x27;s like they have direct access to the database and the PIP can now fetch whatever it needs.</p><p>Personally, I like this architecture because now there is a very clear seperation of who is doing what, even if it means that more code will be required in order to set it up. Building a data service is beyond the scope of this post so I will just keep it simple and say that you shouldn&#x27;t start with this, unless you already have a data service implemented or if you have other needs for it that go beyond authorization.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="variations"></a>Variations<a class="hash-link" href="#variations" title="Direct link to heading">#</a></h4><p>There are a couple of variations with this architecture that I would like to mention since someone might find them interesting.</p><p><strong>Instead of doing the authorization within each internal service, you could do the authorization at the API Gateway.</strong> You can use an authorization middleware within the API Gateway in order to communicate with the authorization service, or, you can even get rid of it completely and communicate with the data service directly from the middleware.</p><div style="text-align:center"><p><img alt="Overview" src="/assets/images/authorization_architecture_api_gateway_data_service-0b3ce09676ba0e94debaec46c09cc681.jpg"></p></div><p>This has the advantage of stopping the request as early as possible before it has the chance to reach the internal services. In general, I like that idea.</p><p>However, it also has a couple of disadvantages: </p><ol><li>When services make internal calls, they will be bypassing the authorization checks. It might be acceptable in your case but personally I do not like it. I want each service to allow only what is expected and nothing more. You could enforce in your implementation to make all the calls go through the API Gateway but then you increase the network latency and you lose all the advantages of actually having an internal network.</li><li>API Gateway will need to have all the application data loaders (for PIP) implemented there and things might get messy if you are implementing too much. Especially if you have a lot of services you might be changing API Gateway too often for reasons unrelated with the service itself.</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="with-an-authorization-middleware-and-library-per-service"></a>With an authorization middleware and library per service<a class="hash-link" href="#with-an-authorization-middleware-and-library-per-service" title="Direct link to heading">#</a></h3><div style="text-align:center"><p><img alt="Overview" src="/assets/images/authorization_architecture_service_library-7003f6c7223ce5634575390d72c385e6.jpg"></p></div><p>In my opinion <strong>this is probably a good balance between complexity and a scalable solution</strong>. You basically keep the authorization logic in each service and each service is responsible for the authorization rules of its own domain.</p><p>One thing you will probably need is to have the common code implemented as a library (or libraries) since it will be shared among all services but it shouldn&#x27;t be a problem. Just make sure you cover it with enough tests!</p><p>The real question with this approach is; <strong>how homogeneous is your system</strong>? If it&#x27;s 100% then you are in luck. You will only need to implement (or find) everything you need once. if it&#x27;s not, you will need to do it for every different language you are using in your system. Even though there are plenty of libraries out there, depending on your system details, they might not integrate very well or they might be missing a couple of features that you might need. Before you are too eager to implement your own, make sure if an existing solution covers your needs. If it does not, maybe you can get away with it by doing a few changes on your side, or by adding those missing features to the library you found. Whatever you do, take the time to decide carefully.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="implementation"></a>Implementation<a class="hash-link" href="#implementation" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="rbac"></a>RBAC<a class="hash-link" href="#rbac" title="Direct link to heading">#</a></h3><p>If you are doing RBAC, then implementing this is straight forward and clean. You just need a middleware (PEP) in which you must check if the user role (usually attached to a JWT that comes with the request) has access to the specified route path. The policies can easily be stored in a database or a configuration file, load them upon service initialization and let the RBAC library (PDP) that you will use do its work from within your middleware. In this case, no PIP is required.</p><p>There are a lot of good solutions out there for RBAC, for any modern web framework from any language, so I will not go into details about this, but I just wanted to briefly mention it. <strong>The only tip I do wanna share though, in case you are implementing something custom</strong>, is that the <strong>resource</strong> in your policies will probably be the <strong>regex route path</strong> and the <strong>permission</strong> will be the <strong>HTTP verb</strong> (<code>GET</code>, <code>DELETE</code>, etc). By doing that, you can easily get the route path from within the middleware and use a regex route matcher library to check if the resource is a match.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="rbacabac"></a>RBAC/ABAC<a class="hash-link" href="#rbacabac" title="Direct link to heading">#</a></h3><p>So let&#x27;s assume that you go with option 3, with an authorization middleware and library per service. How would such implementation look like?</p><p>The following implementation approach is neither the best, nor the only one. It is however applicable to the real world and that&#x27;s what is important for me. <strong>What we are basically trying to answer with our implementation is:</strong></p><ol><li><strong>How will my authorization mechanism load the necessary application data it needs?</strong></li><li><strong>How will I express my policies, in a non confusing way, and be able to access dynamically loaded data from within those policies?</strong></li></ol><p>By answering the above questions we will also be able to provide a better answer back to our friend <em>the monolith</em> and its question, <em>how will we allow a user to do X on Y resource if their roles allows it, or if it&#x27;s owned by them?</em></p><p>The example is written in <code>Node.js</code>, but I am confident you can do something similar in any web framework of your choice. Also, please do keep in mind that I have omitted a lot of code and kept a flat structure in order to try to reduce any confusion with unecessary implementation details. I understand that it can be frustrating but I will try to explain in detail what everything is supposed to do.</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">server.js</div><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports">express</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;express&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// express is a web framework for Node.js </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> logger </span><span class="token string" style="color:#e3116c">&#x27;/your/logger&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">AccessControl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">ROLE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">PREDICATE</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/your/access/control/lib&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// `express.js` router handler for listing items and assigned to route `GET /items`. </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// The assignment is done in our `routesObject` further below.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">listItemsHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">res</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> req</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token maybe-class-name">ItemModel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">query</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ... rest of handler; no authorization checks required </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// `express.js` router handler for getting a specific item and assigned to route `GET /items/:id`. </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// The assignment is done in our `routesObject` further below.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getItemHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">res</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> req</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">params</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token maybe-class-name">ItemModel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">findById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ItemNotFoundError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ... rest of handler; no authorization checks required</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  This is a function that represents an `express.js` middleware. It&#x27;s basically code that will run BEFORE </span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  the `listItemsHandler` and the `getItemHandler` implemented above. The middleware acts as the PEP </span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  and  internally uses our access control library in order to decide if it should allow a request or not.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  </span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  Check here for extra info on middlewares: https://expressjs.com/en/guide/using-middleware.html</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">authorizationExpressMiddleware</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">request</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> response</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> </span><span class="token parameter function" style="color:#d73a49">next</span><span class="token parameter punctuation" style="color:#393A34">(</span><span class="token parameter punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Get the user object from the JWT token that is attached to the request.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Usually this happens within a middleware higher up in the middleware chain.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> user </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">locals</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">user</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> userRole </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">locals</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">user</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">role</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ROLE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">GUEST</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// This is just an object with data that we want to pass to our access control library that is related</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// with this request. Everything in this object will be accessible by specifying the appropriate </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// object path in the `conditions` key of our policy definitions as we will see later.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    user</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> action </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">method</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// GET, DELETE, PUT, etc</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> resource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">baseUrl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">route</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// e.g. /items/:id</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Check if the current request is authorized, by also including our `context` object. </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> isAuthorized </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> accessControl</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">withContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">can</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userRole</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> action</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// If the request is authorized, then pass the control to the next middleware in the chain.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isAuthorized</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Request is UNAUTHORIZED. Set the HTTP response status and stop the rest of the middleware </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// chain from executing by returning an error. The request will stop here.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  response</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">401</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Unauthorized</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AuthorizationError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  Initialization function for our access control library. This is an imaginary custom PDP library</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  that internally uses an imaginary custom PIP library. Using the PIP part of the access control </span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  library should be optional.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initAccessControl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">endpointsObject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// PIP loader function in order to load a specific item and provide to</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// the access control library the extra information it needs.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">pipItemLoader</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">itemId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token maybe-class-name">ItemModel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">findById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">itemId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Initialize the access control library with two roles. The library should be able </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// to support hierarchical roles in order to inherit permissions from a parent role </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// instead of repeating them, just like below.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> roles </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ROLE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">USER</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ROLE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">ADMIN</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    inherits</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">ROLE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">USER</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> accessControl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AccessControl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">roles</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Add our loader to the access control library in order to be able to use it internally when necessary.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessControl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addLoader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">PIP_LOADER_TYPE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">ITEM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pipItemLoader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// `buildPermissions` is a custom utility function that parses the `accessControl` key object value from </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// our endpoints object and creates a list of permission objects, formatted the way our access</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// control library expects them.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> permissions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">buildPermissions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">endpointsObject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessControl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addPermissions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">permissions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> accessControl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// The following object contains everything we need to describe all the exposed routes. Within the object,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// we have also embedded our authorization policies via the `accessControl` key. Within this key, we specify</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// which role can do what and under which conditions.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> routesObject </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    middlewares</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">authorizationExpressMiddleware</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    endpoints</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token string" style="color:#e3116c">&#x27;/items&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;/&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token constant" style="color:#36acaa">GET</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          handler</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> listItemsHandler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          accessControl</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            permissions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">              role</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ROLE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">USER</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">// The &#x27;user&#x27; role can only list items which the `user_id` filter matches the user who request them.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">              condition</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">predicate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PREDICATE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">EQUAL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;$.request.query.user_id&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;$.user.id&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">              role</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ROLE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">ADMIN</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">// The admin role can list items with any filters they like.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">              condition</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Any filter is allowed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;/:id&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token constant" style="color:#36acaa">GET</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handler</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> getItemHandler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            accessControl</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">              loader</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">fn</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PIP_LOADER_TYPE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">ITEM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;$.request.params.id&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">              permissions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                role</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ROLE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">USER</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// The &#x27;user&#x27; role can only get an item that is owned by the user who requested it.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                condition</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">predicate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PREDICATE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">EQUAL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;$.resource.userId&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;$.user.id&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Initialize access control and our app.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> accessControl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initAccessControl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">routesObject</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">endpoints</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">express</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// `buildRoutes` is a custom utility function that parses the routes object and adds all the specified routes </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// to our express.js router by also associated them with the respective handler. The function will also apply</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// the `middlewares` array from the object to all routes which means that each request will need to go</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// through our authorization middleware.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Check the express.js router here: https://expressjs.com/en/guide/routing.html</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">buildRoutes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> routesObject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">listen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">kitten app listening at http://localhost:3000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>I tried to keep the example code as succinct as possible in order for everyone to understand, even if they are not familiar with <code>Node.js</code>. The important take from the code above is that you <em>could</em> use an object to describe your policies, along with your routes, and pass values to those policies by expressing paths from dynamically loaded data that can be used during the evaluation step within our access control library. </p><p>You have probably noticed that in the <code>condition</code> key some weird stuff are happening in the <code>args</code> that are prefixed with <code>$</code>. What is happening there is that I am using <a href="https://restfulapi.net/json-jsonpath/" target="_blank" rel="noopener noreferrer">JSON path syntax</a> in order to specify the location of the data (within the <code>context</code> object) that will be passed as arguments to the predicate; In this case, <code>PREDICATE.EQUAL</code>, which as the name implies, is a predicate for equality check.</p><p>If you re-read the code, you will see that the <code>authorizationMiddleware</code> passes a <code>context</code> object to the access control library that includes the <code>request</code> and <code>user</code> objects. That&#x27;s how they are available for access with the JSON path syntax. As for the <code>$.resource</code> in the <code>args</code>, it&#x27;s just a key name I choose to attach the data returned from the <code>pipItemLoader</code> and automatically attached to the <code>context</code> (this happens inside our imaginary custom PIP library). That means, that the <code>resource</code> represents an <code>item</code> object with a field named <code>userId</code> which we can now access with JSON path syntax.</p><p>Like I have already mentioned, the above is one way to do it, and it works well. You could go with something that is more general-purpose and advanced like a policy engine (e.g <a href="https://www.openpolicyagent.org/" target="_blank" rel="noopener noreferrer">OPA</a>) but I assure you that they are definitely not a free meal either, nor without limitations. Once again, it comes down to the details of your own system and what you are trying to achieve.</p><p><em>(UPDATE 23/05/2022): <a href="https://github.com/cerbos/cerbos" target="_blank" rel="noopener noreferrer">Cerbos</a> recently came to my attention which follows this &quot;contextual&quot; approach I am describing above. Maybe you can check it out as well!</em></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="potential-problems"></a>Potential problems<a class="hash-link" href="#potential-problems" title="Direct link to heading">#</a></h3><p>I would like to briefly mention a few situations that you might come up against as a heads up and what you can try to do in order to solve them.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="bulk-enforcement"></a>Bulk enforcement<a class="hash-link" href="#bulk-enforcement" title="Direct link to heading">#</a></h5><p>This becomes apparent as soon as you have some kind of listing endpoint. How will you check if the user is authorized to access all the items in the result? Checking them one by one is probably the first thing that comes to mind, but that means you will have to load them first, plus, it might be slow if you need to keep loading 1000 items on every request even for users that are not allowed to access that data.</p><p>In our implementation above this is solved with our routes map and the <code>condition</code> key. When you are listing items, you are probably passing some kind of filters to the endpoint via query parameters, which means you can easily use those filters and decide what to do before you even load the data. For roles that are allowed to pass whatever filters they want (e.g. an admin role), you can just omit the <code>condition</code> key.</p><p>The important thing here is that the authorization mechanism is not getting coupled with internal details of how you actually implement your data filtering. It just stays on a very shallow layer of your service which is publicly available to use.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="not-found-requests-in-pip-loaders"></a>Not Found requests in PIP loaders<a class="hash-link" href="#not-found-requests-in-pip-loaders" title="Direct link to heading">#</a></h5><p>This is something that I am still working on myself. I have tried various approaches but I am not 100% satisfied with any of them.</p><p>Let&#x27;s asume that you have your <code>pipItemLoader</code> in which you load an item with id X. What should happen if the item does not exist? Should we return an authorization error? Should we return an <code>ItemNotFound</code> error? If we do the first one, isn&#x27;t it misleading for the API caller? Especially if the user actually has access to load items. If we do the second one, before we check if the user is authorized for this action, wouldn&#x27;t it be bad from a security perspective to provide such info? Maybe we should return a special value from the loader and if it&#x27;s detected to let the request go through, and HOPEFULLY, our controller will be doing checks if the item exists or not.</p><p>You can try any of the above and something might fit your needs, or you can be creative and let me know if you find something interesting as well!</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="duplicate-database-round-trips"></a>Duplicate database round trips<a class="hash-link" href="#duplicate-database-round-trips" title="Direct link to heading">#</a></h5><p>As you might have noticed on our implementation above for the <code>GET</code> endpoint, is that we are loading the same item twice; once in the <code>pipItemLoader</code> and once in <code>getItemHandler</code>. Why hit the database twice when you can just avoid it?</p><p>One solution is to cache the data in order for the second call to return the cached data. But why hit the cache when you can avoid that as well? How? Just use a data loader and persist the data in RAM (and cache them as a side effect) for as long as the request lives and clear them upon finish with a middleware. For example, for <code>Node.js</code> you could use the <a href="https://www.npmjs.com/package/dataloader" target="_blank" rel="noopener noreferrer">dataloader</a> package. I am pretty sure there are similar solutions in whatever you might be using.</p><p>Of course, none of this is necessary and might be too much. Once again, it depends on how everything is implemented on your side and more importantly, your incoming traffic load.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="restricting-resource-fields"></a>Restricting resource fields<a class="hash-link" href="#restricting-resource-fields" title="Direct link to heading">#</a></h5><p>Depending on user access level, return resources with specific fields removed. Some authorization libraries that I have seen provide a way to do this by exposing a function/method, but in my opinion this does not really belong there. I feel like this is a job for an authorization middleware, or at least something other than the library itself which should be kept as tight as possible.</p><p>If you are using the routes map approach above, then you can easily extend it to support this by adding an extra key that describes the fields that are allowed and let the middleware remove the rest.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>As you saw, implementing authorization is hard, but it&#x27;s also a very interesting challenge.</p><p>Although there is a popular belief that in a monolith is easier to implement authorization, in my opinion both the monolith and a microservices architecture have a lot in common when it comes to the authorization mechanism when that same mechanism has access to the application data it needs. The main difference is, as long as that mechanism no longer has a straight forward way to get that data, things start to get more complicated. Due to the independent nature of microservices, this can be easily observed, but the same complexity can be also observed within the same organization if multiple monoliths need to have a common authorization system.</p><p>I am definitely not done with looking for better solutions than the ones I have already suggested and I am looking forward to hearing what others are doing.</p><p>The good thing is, that more and more people are starting to take this more seriously and spend more time on it (I strongly recommend checking out <a href="https://www.osohq.com/" target="_blank" rel="noopener noreferrer">Oso</a> and <a href="https://www.osohq.com/post/why-authorization-is-hard" target="_blank" rel="noopener noreferrer">this</a> article by the company&#x27;s CTO, Sam Scott). </p><p>Hopefully, at some point we will solve it more elegantly and have a more unified approach. Until then, good luck!</p><p><strong>PS:</strong> I know you are going to ask me, so I am telling you right now that I made all the diagrams with <a href="https://drawio-app.com/" target="_blank" rel="noopener noreferrer">draw.io</a>.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/tags/microservices">microservices</a><a class="margin-horiz--sm" href="/tags/authorization">authorization</a><a class="margin-horiz--sm" href="/tags/architecture">architecture</a><a class="margin-horiz--sm" href="/tags/battlefield">battlefield</a><a class="margin-horiz--sm" href="/tags/development">development</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/my-2021-reads"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">My 2021 reads Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-monolith" class="table-of-contents__link">The monolith</a></li><li><a href="#authorization-flow-overview" class="table-of-contents__link">Authorization flow overview</a></li><li><a href="#architectures" class="table-of-contents__link">Architectures</a><ul><li><a href="#with-an-authorization-service" class="table-of-contents__link">With an authorization service</a></li><li><a href="#with-an-authorization-service-and-a-data-service" class="table-of-contents__link">With an authorization service and a data service</a></li><li><a href="#with-an-authorization-middleware-and-library-per-service" class="table-of-contents__link">With an authorization middleware and library per service</a></li></ul></li><li><a href="#implementation" class="table-of-contents__link">Implementation</a><ul><li><a href="#rbac" class="table-of-contents__link">RBAC</a></li><li><a href="#rbacabac" class="table-of-contents__link">RBAC/ABAC</a></li><li><a href="#potential-problems" class="table-of-contents__link">Potential problems</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Alexander's Blog. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.21506163.js"></script>
<script src="/assets/js/main.6357892d.js"></script>
</body>
</html>